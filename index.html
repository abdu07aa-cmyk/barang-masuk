<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Report Barang Masuk - Final</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{font-family:Arial;padding:10px;background:#f4f6f8}
input,select,button{padding:8px;margin:5px;width:100%}
table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff}
th,td{border:1px solid #ccc;padding:6px;font-size:12px;text-align:center}
th{background:#eee}
.btn{background:#007bff;color:#fff;border:none;border-radius:5px;cursor:pointer;margin-top:5px}
.btn-green{background:#28a745;color:#fff;border:none;border-radius:5px;cursor:pointer;margin-top:5px}
.btn-red{background:#dc3545;color:#fff;border:none;border-radius:5px;cursor:pointer;margin-top:5px}
.btn-yellow{background:#ffc107;color:#000;border:none;border-radius:5px;cursor:pointer;margin-top:5px}
</style>
</head>
<body>

<h3>üì¶ Report Barang Masuk (Final)</h3>
<input type="date" id="tanggal">
<input type="text" id="brand" placeholder="Nama Brand">

<table id="inputTable">
<tr><th>Jenis</th><th>Paper</th><th>Size</th><th>Qty</th><th>Aksi</th></tr>
</table>

<button id="btnTambah" class="btn">+ Tambah Barang</button>
<button id="btnSimpan" class="btn">üíæ Simpan</button>

<h3>Data Tersimpan</h3>
<table id="dataTable">
<tr><th>Tanggal</th><th>Brand</th><th>Jenis</th><th>Paper</th><th>Size</th><th>Qty</th><th>Aksi</th></tr>
</table>

<button id="btnExcelTable" class="btn-green">üìÑ Export Excel</button>
<button id="btnWATable" class="btn-green">üì≤ Kirim WA</button>

<script>
  function formatTanggal(tgl){
  if(!tgl) return "";
  const [y,m,d] = tgl.split("-");
  return `${d}/${m}/${y}`;
}

function formatTanggalDB(tgl){
  // dari DD/MM/YYYY ke YYYY-MM-DD (kalau dibutuhkan)
  const [d,m,y] = tgl.split("/");
  return `${y}-${m}-${d}`;
}

document.addEventListener("DOMContentLoaded", ()=>{

const supabase = window.supabase.createClient(
  "https://dggspzjibisapdaowkkj.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRnZ3NwemppYmlzYXBkYW93a2tqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NjMxNzksImV4cCI6MjA4MzQzOTE3OX0.DtDb10SzKfwJg3bbVq53nG9RIXbZYtitXn67ZtdBMFY"
);

const jenis=["BOOKLET","FILTER WHITE","FILTER BROWN","FILTER PRINTED","DISPLAY","PLAT","MAGNET","DOUBLE TAPE","COVER","PAPER",
"MIKA","STICKER MIKA","STICKER FILTER","STICKER BULAT BESAR","STICKER BULAT KECIL","TUBE","FILTER 21","FILTER 26",
"FILTER 30","FILTER 40","HOLDER S","HOLDER M","HOLDER L","HOLDER 9X9","HOLDER 10X10"];
const paper=["32 LEAVES","33 LEAVES","35 LEAVES","40 LEAVES","42 LEAVES","50 LEAVES","51 LEAVES","52 LEAVES",
"60 LEAVES","70 MM","83 MM","84 MM","98 MM","109 MM","110 MM"];
const size=["1 1/4","SINGLE","KS","KSS","KSSS","SKS","3 CONES/PACK","6 CONES/PACK","8 CONES/PACK","700 CONES/BOX",
"729 CONES/BOX","900 CONES/BOX","800 CONES/BOX","1000 CONES/BOX"];
const opt=l=>'<option></option>'+l.map(v=>`<option>${v}</option>`).join('');

function tambahBaris(){
  const r=inputTable.insertRow(-1);
  r.innerHTML=`<td><select>${opt(jenis)}</select></td>
  <td><select>${opt(paper)}</select></td>
  <td><select>${opt(size)}</select></td>
  <td><input type="number" min="1"></td>
  <td><button class="btn-red" onclick="this.closest('tr').remove()">X</button></td>`;
}

function addRowToTable(d){
  const tr=document.createElement('tr');
  tr.dataset.id=d.id;
  tr.innerHTML=`<td>${formatTanggal(d.tanggal)}</td>
<td>${d.brand}</td><td>${d.jenis}</td><td>${d.paper}</td>
  <td>${d.size}</td><td>${d.qty}</td>
  <td><button class="btn-yellow" onclick="editRow(this)">Edit</button>
  <button class="btn-red" onclick="deleteRow(this)">Hapus</button></td>`;
  dataTable.appendChild(tr);
}

async function loadData(){
  const { data } = await supabase.from("barang_masuk").select("*").order("id",{ascending:false});
  dataTable.innerHTML='<tr><th>Tanggal</th><th>Brand</th><th>Jenis</th><th>Paper</th><th>Size</th><th>Qty</th><th>Aksi</th></tr>';
  data.forEach(d=>addRowToTable(d));
}

async function simpan(){
  if(!tanggal.value||!brand.value){ alert("Tanggal & Brand wajib diisi"); return; }
  const rows=[...inputTable.rows].slice(1);
  if(rows.length===0){ alert("Tidak ada data"); return; }

  const dataToInsert = rows.map(r=>{
    const e=r.querySelectorAll("select,input");
    return {tanggal:tanggal.value,brand:brand.value,jenis:e[0].value,paper:e[1].value,size:e[2].value,qty:+e[3].value};
  });

  const { error, data } = await supabase.from("barang_masuk").insert(dataToInsert).select();
  if(error){ alert(error.message); return; }

  inputTable.innerHTML='<tr><th>Jenis</th><th>Paper</th><th>Size</th><th>Qty</th><th>Aksi</th></tr>';
  data.forEach(d=>addRowToTable(d));
  alert("‚úÖ Data tersimpan");
}

window.editRow = async function(btn){
  const tr=btn.closest('tr');
  const id=tr.dataset.id;
  const tanggalText = formatTanggalDB(tr.cells[0].textContent);
  const brandText=tr.cells[1].textContent;
  const jenisText=tr.cells[2].textContent;
  const paperText=tr.cells[3].textContent;
  const sizeText=tr.cells[4].textContent;
  const qtyText=tr.cells[5].textContent;

  tr.innerHTML=`<td><input type="date" value="${tanggalText}"></td>
  <td><input type="text" value="${brandText}"></td>
  <td><select>${opt(jenis)}</select></td>
  <td><select>${opt(paper)}</select></td>
  <td><select>${opt(size)}</select></td>
  <td><input type="number" min="1" value="${qtyText}"></td>
  <td><button class="btn-green" onclick="saveEdit(this)">Simpan</button>
  <button class="btn-red" onclick="cancelEdit(this,'${tanggalText}','${brandText}','${jenisText}','${paperText}','${sizeText}','${qtyText}')">Batal</button></td>`;

  tr.cells[2].querySelector('select').value=jenisText;
  tr.cells[3].querySelector('select').value=paperText;
  tr.cells[4].querySelector('select').value=sizeText;
}

window.cancelEdit = function(btn,tanggal,brand,jenis,paper,size,qty){
  const tr=btn.closest('tr');
  tr.innerHTML=`<td>${formatTanggal(tanggal)}</td>
<td>${brand}</td><td>${jenis}</td><td>${paper}</td><td>${size}</td><td>${qty}</td>
  <td><button class="btn-yellow" onclick="editRow(this)">Edit</button>
  <button class="btn-red" onclick="deleteRow(this)">Hapus</button></td>`;
}

window.saveEdit = async function(btn){
  const tr=btn.closest('tr');
  const id=tr.dataset.id;
  const tanggal=tr.cells[0].querySelector('input').value;
  const brand=tr.cells[1].querySelector('input').value;
  const jenis=tr.cells[2].querySelector('select').value;
  const paper=tr.cells[3].querySelector('select').value;
  const size=tr.cells[4].querySelector('select').value;
  const qty=tr.cells[5].querySelector('input').value;

  const { error }=await supabase.from("barang_masuk").update({tanggal,brand,jenis,paper,size,qty:+qty}).eq('id',id);
  if(error){ alert(error.message); return; }

  tr.innerHTML=`<td>${formatTanggal(tanggal)}</td>
<td>${brand}</td><td>${jenis}</td><td>${paper}</td><td>${size}</td><td>${qty}</td>
  <td><button class="btn-yellow" onclick="editRow(this)">Edit</button>
  <button class="btn-red" onclick="deleteRow(this)">Hapus</button></td>`;
}

window.deleteRow = async function(btn){
  if(!confirm("Yakin hapus data ini?")) return;
  const tr=btn.closest('tr');
  const id=tr.dataset.id;
  const { error }=await supabase.from("barang_masuk").delete().eq('id',id);
  if(error){ alert(error.message); return; }
  tr.remove();
}

// ================= Export Excel aman untuk Size ===================
function exportExcelTable(){
  const rows = [...dataTable.rows].slice(1);
  const data = rows.map(r=>({
    Tanggal: r.cells[0].textContent,
    Brand: r.cells[1].textContent,
    Jenis: r.cells[2].textContent,
    Paper: r.cells[3].textContent,
    Size: r.cells[4].textContent,
    Qty: Number(r.cells[5].textContent)
  }));

  const ws = XLSX.utils.json_to_sheet(data);

  // Paksa kolom Size jadi TEXT
  const range = XLSX.utils.decode_range(ws['!ref']);
  for(let R=1; R<=range.e.r; R++){
    const cell = ws[XLSX.utils.encode_cell({r:R, c:4})];
    if(cell){
      cell.t = "s"; // string
    }
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Barang Masuk");
  XLSX.writeFile(wb,"barang_masuk.xlsx");

}

// ================= Kirim WA per Brand & Tanggal ===================
function sendWATable(){
 const tanggalValue = formatTanggal(tanggal.value);
  const brandValue = brand.value.trim();
  if(!tanggalValue || !brandValue){ alert("Isi tanggal & brand untuk WA"); return; }

  let txt = "üì¶ *REPORT BARANG MASUK*\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
  txt += `üìÖ *${tanggalValue}*\nüè∑Ô∏è Brand: *${brandValue}*\n\n`;

  [...dataTable.rows].slice(1)
    .filter(r=>r.cells[0].textContent===tanggalValue && r.cells[1].textContent===brandValue)
    .forEach(r=>{
      txt += `‚Ä¢ ${r.cells[2].textContent} | ${r.cells[3].textContent} | ${r.cells[4].textContent} | Qty: *${r.cells[5].textContent}*\n`;
    });

  txt += "\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
  const now = new Date();
  txt += `üïê Generated: ${now.toLocaleDateString()} , ${now.toLocaleTimeString()}`;

  window.open("https://wa.me/?text="+encodeURIComponent(txt));
}

// ================= Tombol ===================
btnTambah.onclick=tambahBaris;
btnSimpan.onclick=simpan;
btnExcelTable.onclick=exportExcelTable;
btnWATable.onclick=sendWATable;

loadData();

});
</script>
</body>
</html>
